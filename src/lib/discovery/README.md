# GitHub Repository Discovery System

A comprehensive GitHub repository scanning and catalog population system for Backstage.io integration.

## Overview

This system provides:

1. **GitHubScanner**: Core scanning library with OAuth/App authentication
2. **GitHubDiscovery**: React component for interactive scanning and importing
3. **GitHubScheduler**: Automated scheduled scanning with cron jobs
4. **API Routes**: RESTful endpoints for scan, import, and scheduler management

## Features

### Authentication
- Personal Access Token authentication
- GitHub App authentication with installation ID
- Automatic rate limit handling with exponential backoff

### Repository Discovery
- Organization-wide repository scanning
- User repository scanning
- Specific repository targeting
- Private repository support (with appropriate permissions)
- Fork and archived repository filtering

### Catalog Entity Detection
- Automatic `catalog-info.yaml` file detection
- Support for multiple catalog file locations
- YAML parsing and validation
- Auto-generation of catalog entries for repositories without existing files

### Framework & Language Detection
- Automatic programming language detection
- Framework identification (React, Next.js, Vue, Angular, Spring Boot, Django, etc.)
- Dependency scanning (package.json, requirements.txt, go.mod, pom.xml, Gemfile)
- Confidence scoring for framework detection

### Team & Ownership Mapping
- CODEOWNERS file parsing
- GitHub team integration
- Maintainer identification
- Ownership assignment

### Batch Processing
- Configurable batch sizes for API efficiency
- Rate limit compliance with automatic delays
- Concurrent processing with limits
- Progress tracking and error reporting

### Scheduled Operations
- Cron-based scheduled scanning
- Automatic catalog population
- Notification system (webhooks, email)
- Execution history and statistics
- Configuration management

## Quick Start

### 1. Basic Repository Scanning

```typescript
import { GitHubScanner } from '@/lib/discovery/GitHubScanner';

const scanner = new GitHubScanner({
  token: 'ghp_xxxxxxxxxxxxxxxxxxxx', // Your GitHub token
});

const result = await scanner.scanRepositories({
  organizations: ['my-org'],
  includePrivate: true,
  dryRun: false,
});

console.log(`Found ${result.totalScanned} repositories`);
console.log(`${result.summary.withCatalogInfo} already have catalog-info.yaml`);
console.log(`${result.summary.autoGenerated} auto-generated catalog entries`);
```

### 2. Using the React Component

```tsx
import { GitHubDiscovery } from '@/components/catalog/GitHubDiscovery';

function MyDiscoveryPage() {
  return (
    <GitHubDiscovery
      onRepositoriesScanned={(repos) => {
        console.log(`Scanned ${repos.length} repositories`);
      }}
      onRepositoriesImported={(count) => {
        console.log(`Imported ${count} repositories to catalog`);
      }}
    />
  );
}
```

### 3. Setting Up Scheduled Scanning

```typescript
import { getGitHubScheduler } from '@/lib/discovery/GitHubScheduler';

const scheduler = getGitHubScheduler();

await scheduler.addScheduledScan({
  id: 'daily-org-scan',
  name: 'Daily Organization Scan',
  description: 'Scan all repositories in the organization daily',
  enabled: true,
  schedule: '0 2 * * *', // Daily at 2 AM UTC
  githubConfig: {
    token: process.env.GITHUB_TOKEN,
  },
  scanOptions: {
    organizations: ['my-org'],
    includePrivate: true,
    includeForks: false,
    dryRun: false,
  },
  importOptions: {
    overwriteExisting: false,
    generateMissing: true,
    defaultOwner: 'platform-team',
    addTags: ['github-scheduled', 'auto-imported'],
  },
  notifications: {
    onSuccess: ['https://hooks.slack.com/success-webhook'],
    onFailure: ['https://hooks.slack.com/failure-webhook'],
  },
});
```

## API Usage

### Scan Repositories

```bash
curl -X POST http://localhost:3000/api/catalog/discovery/github/scan \
  -H "Content-Type: application/json" \
  -d '{
    "config": {
      "token": "ghp_xxxxxxxxxxxxxxxxxxxx"
    },
    "options": {
      "organizations": ["my-org"],
      "includePrivate": true,
      "dryRun": false
    }
  }'
```

### Import Repositories

```bash
curl -X POST http://localhost:3000/api/catalog/discovery/github/import \
  -H "Content-Type: application/json" \
  -d '{
    "repositories": [...], // Array of repository objects from scan
    "options": {
      "overwriteExisting": false,
      "generateMissing": true,
      "defaultOwner": "platform-team"
    }
  }'
```

### Manage Scheduled Scans

```bash
# Create scheduled scan
curl -X POST http://localhost:3000/api/catalog/discovery/github/scheduler \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Daily Scan",
    "schedule": "0 2 * * *",
    "githubConfig": { "token": "..." },
    "scanOptions": { "organizations": ["my-org"] }
  }'

# Execute immediately
curl -X POST http://localhost:3000/api/catalog/discovery/github/scheduler/actions \
  -H "Content-Type: application/json" \
  -d '{
    "action": "execute",
    "configId": "github-scan-1234567890-abc123def"
  }'

# Get all configurations and stats
curl http://localhost:3000/api/catalog/discovery/github/scheduler
```

## Configuration Options

### GitHub Configuration

```typescript
interface GitHubConfig {
  // Personal Access Token
  token?: string;
  
  // GitHub App (preferred for organizations)
  appId?: number;
  privateKey?: string;
  installationId?: number;
  
  // Custom GitHub Enterprise URL
  baseUrl?: string;
}
```

### Scan Options

```typescript
interface ScanOptions {
  // Target repositories
  organizations?: string[];
  users?: string[];
  repositories?: string[]; // Format: "owner/repo"
  
  // Filtering
  includePrivate?: boolean;
  includeArchived?: boolean;
  includeForks?: boolean;
  
  // Performance
  batchSize?: number; // 1-100, default: 50
  rateLimitDelay?: number; // ms, default: 1000
  maxConcurrent?: number; // 1-10, default: 5
  
  // Testing
  dryRun?: boolean; // default: true
}
```

### Import Options

```typescript
interface ImportOptions {
  overwriteExisting?: boolean; // default: false
  skipValidation?: boolean; // default: false
  generateMissing?: boolean; // default: true
  defaultOwner?: string; // default: "unknown"
  defaultLifecycle?: string; // default: "experimental"
  addTags?: string[]; // default: ["github-imported"]
}
```

## Framework Detection

The system automatically detects frameworks and libraries based on:

- **File presence**: package.json, requirements.txt, go.mod, etc.
- **Content patterns**: Specific dependency declarations
- **Configuration files**: Framework-specific config files

### Supported Frameworks

- **Frontend**: React, Next.js, Vue.js, Angular, Svelte
- **Backend**: Express.js, Spring Boot, Django, Flask, Ruby on Rails, Laravel
- **Mobile**: React Native, Flutter
- **Infrastructure**: Terraform, Ansible, Docker

### Detection Confidence

Each detection includes a confidence score:
- **95%+**: High confidence (multiple strong indicators)
- **80-94%**: Medium confidence (some indicators)
- **<80%**: Low confidence (weak indicators)

## Dependency Scanning

The system scans various dependency files:

### Node.js (package.json)
- Dependencies, devDependencies, peerDependencies
- Framework detection from package names
- Version range analysis

### Python (requirements.txt, Pipfile, pyproject.toml)
- Package dependencies with versions
- Framework detection (Django, Flask, FastAPI)
- Development vs production dependencies

### Go (go.mod)
- Module dependencies with versions
- Framework detection from import paths
- Replace and exclude directives

### Java (pom.xml, build.gradle)
- Maven/Gradle dependencies
- Spring Boot and other framework detection
- Dependency scopes and exclusions

### Ruby (Gemfile)
- Gem dependencies with versions
- Rails and other framework detection
- Group-based dependencies

## Team Ownership Integration

### CODEOWNERS Support
- Parses CODEOWNERS files from standard locations
- Maps file patterns to team/user ownership
- Integrates with GitHub team structure

### Ownership Assignment
- Automatic owner assignment based on CODEOWNERS
- Fallback to repository collaborators
- Custom ownership rules and overrides

## Error Handling & Monitoring

### Rate Limit Management
- Automatic rate limit detection
- Exponential backoff retry logic
- Graceful degradation under limits

### Error Reporting
- Detailed error tracking per repository
- Categorized error types (auth, not found, parsing, etc.)
- Comprehensive logging for debugging

### Progress Tracking
- Real-time progress updates
- Batch completion status
- Performance metrics and timing

## Security Considerations

### Authentication
- Secure token storage (environment variables)
- GitHub App preferred over personal tokens
- Minimal required permissions (read-only for scanning)

### Data Privacy
- No repository content stored permanently
- Metadata-only extraction
- Audit logging of all operations

### Access Control
- Repository visibility respected
- Private repository handling
- Organization permission boundaries

## Performance Optimization

### Caching
- API response caching for repeated requests
- Repository metadata caching
- Framework detection result caching

### Batch Processing
- Optimal batch sizes for GitHub API
- Parallel processing within rate limits
- Memory-efficient streaming for large datasets

### Resource Management
- Connection pooling for HTTP requests
- Memory cleanup for large scans
- Graceful shutdown handling

## Troubleshooting

### Common Issues

1. **Rate Limit Exceeded**
   - Solution: Increase `rateLimitDelay` or decrease `maxConcurrent`
   - Use GitHub App authentication for higher limits

2. **Authentication Failures**
   - Verify token has required permissions
   - Check token expiration and renewal
   - Ensure proper scope for private repositories

3. **Missing Repositories**
   - Check organization membership
   - Verify repository visibility settings
   - Review filtering options (archived, forks)

4. **Framework Detection Issues**
   - Review detection confidence scores
   - Check supported framework patterns
   - Manual override via catalog annotations

### Debug Mode

Enable debug logging:

```typescript
const scanner = new GitHubScanner(config);
// Enable debug logging in scanner
process.env.DEBUG = 'github-scanner:*';
```

### Health Checks

The system provides health check endpoints:

```bash
# Check scanner health
curl http://localhost:3000/api/catalog/discovery/github/scan

# Check scheduler health
curl http://localhost:3000/api/catalog/discovery/github/scheduler
```

## Integration Examples

### Backstage.io Integration

```yaml
# catalog-info.yaml
apiVersion: backstage.io/v1alpha1
kind: Component
metadata:
  name: my-service
  annotations:
    github.com/project-slug: my-org/my-service
    backstage.io/managed-by-location: url:https://github.com/my-org/my-service
spec:
  type: service
  lifecycle: production
  owner: team-alpha
```

### CI/CD Integration

```yaml
# .github/workflows/catalog-sync.yml
name: Sync Catalog
on:
  schedule:
    - cron: '0 6 * * *'
  
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Catalog Sync
        run: |
          curl -X POST "${{ secrets.BACKSTAGE_URL }}/api/catalog/discovery/github/scheduler/actions" \
            -H "Authorization: Bearer ${{ secrets.BACKSTAGE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "execute", "configId": "${{ secrets.SYNC_CONFIG_ID }}"}'
```

## Contributing

### Development Setup

1. Install dependencies: `npm install`
2. Set environment variables:
   ```bash
   GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx
   ```
3. Run tests: `npm run test`
4. Start development server: `npm run dev`

### Testing

```bash
# Unit tests
npm run test

# Integration tests with real GitHub API
GITHUB_TOKEN=xxx npm run test:integration

# End-to-end tests
npm run test:e2e
```

### Code Style

Follow the existing code style:
- TypeScript strict mode
- ESLint configuration
- Prettier formatting
- Comprehensive JSDoc comments

## License

This project is part of the Backstage IDP wrapper and follows the same licensing terms.

## Support

For issues and questions:
1. Check the troubleshooting section
2. Review API documentation endpoints
3. Enable debug logging for detailed information
4. Check GitHub API status and rate limits